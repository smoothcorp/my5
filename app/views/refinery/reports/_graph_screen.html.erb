<% if  (!@reports.nil? && !@reports.blank?) || (!@custmer_visit.blank? && !@custmer_visit.nil?) %>
  <% if  params[:graph_view] == "1" %>
    <script type="text/javascript">
      $(function() {
        var chart;
        $(document).ready(function() {
//  =========================================================================================================

          var day_of_months
          day_of_months = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 3131, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

          var report_day_array = <%= @report_day_array %>
          var start_date_index = 0;
          var year
          var month

          var day
          var date_array;
          var report_day_date = <%= @report_day_date %>

          var current_month
          current_month = report_day_date[start_date_index].split(' ')[1] - 1;


          var round = <%= @round %>
          var arr = [];
          var monthly = [];
          var avarage = 0;

          var j = current_month;
          var j_m
          if ( round == 30 ) {
            j_m = current_month - 1;
          } else if ( round == 60 ) {
            j_m = current_month - 2;
          } else if ( round == 90 ) {
            j_m = current_month - 3;
          }


          if ( round == 30 || round == 60 || round == 90 ) {
            Array.prototype.each_slice = function( size, callback ) {
              for ( var i = 0, l = this.length; i < l; ) {
                if ( round == 30 ) {
                  j += 1;
                  callback.call(this, this.slice(i, i + size[j]));
                  i += size[j];
                } else if ( round == 60 ) {
                  j += 2;
                  callback.call(this, this.slice(i, i + size[j] + size[j + 1]));
                  i += size[j] + size[j + 1];
                } else if ( round == 90 ) {
                  j += 3;
                  callback.call(this, this.slice(i, i + size[j] + size[j + 1] + size[j + 2]));
                  i += size[j] + size[j + 1] + size[j + 2];
                }
              }
            };

            Array.prototype.each_slice_month = function( size, callback ) {
              for ( var i = 0, l = this.length; i < l; ) {
                if ( round == 30 ) {
                  j_m += 1;
                  callback.call(this, this.slice(i, i + size[j_m]));
                  i += size[j_m];
                } else if ( round == 60 ) {
                  j_m += 2;
                  callback.call(this, this.slice(i, i + size[j_m] + size[j_m + 1]));
                  i += size[j_m] + size[j_m + 1];
                } else if ( round == 90 ) {
                  j_m += 3;
                  callback.call(this, this.slice(i, i + size[j_m] + size[j_m + 1] + size[j_m + 2]));
                  i += size[j_m] + size[j_m + 1]  + size[j_m + 2];
                }
              }
            };

            /*Count!*/
            report_day_array.reverse().each_slice(day_of_months, function( sub_array ) {
              $.each(sub_array, function() {
                avarage += this;
              });

              arr.push(avarage);
              avarage = 0;
            });


            /*Months!*/
            report_day_date.each_slice_month(day_of_months, function( sub_array ) {
              monthly.push(sub_array[0]);
            });

          } else {
            Array.prototype.each_slice = function( size, callback ) {
              for ( var i = 0, l = this.length; i < l; i += size ) {
                callback.call(this, this.slice(i, i + size));
              }
            };

            /*Count!*/
            report_day_array.reverse().each_slice(round, function( sub_array ) {
              $.each(sub_array, function() {
                avarage += this;
              });

              arr.push(avarage);
              avarage = 0;
            });
          }


          if ( arr.length > 7 ) {
            arr = arr.slice(0, 7);
            monthly = monthly.reverse().slice(0, 7);
            monthly = monthly.reverse();
            start_date_index = report_day_date.length - (6 * round) - 1;
          }


          arr.reverse();

          date_array = report_day_date[start_date_index].split(' ');

          year = date_array[0];
          month = date_array[1];
          day = date_array[2];

          year = parseInt(year, 10);
          month = parseInt(month, 10) - 1;
          day = parseInt(day, 10);


          var m_onthly = monthly;
          var a_rr = arr;


          var some = [];

          function toDate( strDate ) {
            var args = strDate.split(' ').map(Number);
            args[1] = args[1] - 1;
            return Date.UTC.apply(Date, args);
          }

          for ( var i = 0, length = m_onthly.length; i < length; i += 1 ) {
            some[i] = {
              x: toDate(m_onthly[i]),
              y: a_rr[ i ]
            };
          }


//      console.log('========');
//      console.log(year);
//      console.log(month);
//      console.log(day);
//      console.log(monthly);
//      console.log(arr);
//      console.log(some);
//      console.log('========');
//      console.log(round);
//  =========================================================================================================

          if ( round == 30 || round == 60 || round == 90 ) {
            chart = new Highcharts.Chart({
              chart: {
                renderTo: 'container',
                type: 'line',
                marginRight: 130,
                marginBottom: 25
              },
              title: {
                text: 'Line - Graph',
                x: -20 //center
              },
              subtitle: {
                text: '',
                x: -20
              },
              xAxis: {
                type: 'datetime',

                dateTimeLabelFormats: {
                  hour: '%H:%M',
                  day: '%e %b',
                  week: '%e %b',
                  month: '%b %Y',
                  year: '%b %Y'
                }
              },
              yAxis: {
                title: {
                  text: 'Page views'
                },
                plotLines: [
                  {
                    value: 0,
                    width: 1,
                    color: '#808080'
                  }
                ]
              },
              tooltip: {
                formatter: function() {
                  return '<b>' + this.series.name + '</b><br/>' +
                      Highcharts.dateFormat("%e %b'%y", this.x) + ': ' + Math.round(this.y).toFixed(1) + ' \u00A0 ';
                }
              },
              legend: {
                layout: 'vertical',
                align: 'right',
                verticalAlign: 'top',
                x: -10,
                y: 100,
                borderWidth: 0
              },
              series: [
                {
                  name: 'Visits',
                  data: some
                }
              ]
            });
          } else {
            chart = new Highcharts.Chart({
              chart: {
                renderTo: 'container',
                type: 'line',
                marginRight: 130,
                marginBottom: 25
              },
              title: {
                text: 'Line - Graph',
                x: -20 //center
              },
              subtitle: {
                text: '',
                x: -20
              },
              xAxis: {
                type: 'datetime',

                dateTimeLabelFormats: {
                  hour: '%H:%M',
                  day: '%e %b',
                  week: '%e %b',
                  month: '%b %Y',
                  year: '%b %Y'
                }
              },
              yAxis: {
                title: {
                  text: 'Page views'
                },
                plotLines: [
                  {
                    value: 0,
                    width: 1,
                    color: '#808080'
                  }
                ]
              },
              tooltip: {
                formatter: function() {
                  return '<b>' + this.series.name + '</b><br/>' +
                      Highcharts.dateFormat("%e %b'%y", this.x) + ': ' + Math.round(this.y).toFixed(1) + ' \u00A0 ';
                }
              },
              legend: {
                layout: 'vertical',
                align: 'right',
                verticalAlign: 'top',
                x: -10,
                y: 100,
                borderWidth: 0
              },
              series: [
                {
                  name: 'Visits',
                  data: arr,
                  pointStart: Date.UTC(year, month, day),
                  pointInterval: <%= @round * 24 * 3600 * 1000 %>
                }
              ]
            });
          }
        });

      });
    </script>




  <% elsif params[:graph_view] == "2" %>
    <div align="right"><%= link_to("COLUMN", '#', :class => "button graphs_type", :id => "column_graph") %> <%= link_to("BAR", '#', :class => "button graphs_type", :id => "bar_graph") %>  <%= link_to("PIE", '#', :class => "button graphs_type", :id => "pie_graph") %></div>
    <script type="text/javascript">
      $(function() {
        var chart;
        $(document).ready(function() {
          chart = new Highcharts.Chart({
            chart: {
              renderTo: 'container',
              type: 'column'
            },
            title: {
              text: 'Column graph'
            },
            subtitle: {
              text: ''
            },
            xAxis: {
              categories: <%=@report_day_date%>
            },
            yAxis: {
              min: 0,
              title: {
                text: ''
              }
            },
            legend: {
              layout: 'vertical',
              backgroundColor: '#FFFFFF',
              align: 'left',
              verticalAlign: 'top',
              x: 100,
              y: 70,
              floating: true,
              shadow: true
            },
            tooltip: {
              formatter: function() {
                return '' +
                    this.x + ': ' + this.y + ' Visits';
              }
            },
            plotOptions: {
              column: {
                pointPadding: 0.2,
                borderWidth: 0
              }
            },
            series: [
              {
                name: 'Visits',
                data: <%=@report_day_array.to_s%>

              }
            ]
          });
        });

      });
    </script>
    <script type="text/javascript">
      $(function() {
        var chart;
        $(document).ready(function() {
          chart = new Highcharts.Chart({
            chart: {
              renderTo: 'bar_container_graph',
              type: 'bar'
            },
            title: {
              text: 'Bar graph'
            },
            subtitle: {
              text: ''
            },
            xAxis: {
              categories: <%=@report_day_date%>
            },
            yAxis: {
              min: 0,
              title: {
                text: ''
              }
            },
            legend: {
              layout: 'vertical',
              backgroundColor: '#FFFFFF',
              align: 'left',
              verticalAlign: 'top',
              x: 100,
              y: 70,
              floating: true,
              shadow: true
            },
            tooltip: {
              formatter: function() {
                return '' +
                    this.x + ': ' + this.y + ' Visits';
              }
            },
            plotOptions: {
              column: {
                pointPadding: 0.2,
                borderWidth: 0
              }
            },
            series: [
              {
                name: 'Visits',
                data: <%=@report_day_array.to_s%>

              }
            ]
          });
        });

      });
    </script>
    <% if @pie_sum_totals.to_i > 0 %>
      <script type="text/javascript">
        $(function() {
          var chart;
          $(document).ready(function() {
            chart = new Highcharts.Chart({
              chart: {
                renderTo: 'pie_container_graph',
                plotBackgroundColor: null,
                plotBorderWidth: null,
                plotShadow: false
              },
              title: {
                text: 'Pie graph'
              },
              tooltip: {
                formatter: function() {
                  return '<b>' + this.point.name + '</b>: ' + this.percentage.toFixed(2) + ' %';
                }
              },
              plotOptions: {
                pie: {
                  allowPointSelect: true,
                  cursor: 'pointer',
                  dataLabels: {
                    enabled: true,
                    color: '#000000',
                    connectorColor: '#000000',
                    formatter: function() {
                      return '<b>' + this.point.name + '</b>: ' + this.percentage.toFixed(2) + ' %';
                    }
                  }
                }
              },
              series: [
                {
                  type: 'pie',
                  name: 'Visits in %',
                  data: <%= @pie_graph_view_data %>
                }
              ]
            });
          });

        });
      </script>
    <% end %>
  <% elsif params[:graph_view] == "3" %>
    <%= render 'screen_2' %>
  <% end %>
  <% if params[:graph_view] == "1" %>
    <div style="border:5px grey solid;">
      <div id="container" style="min-width:900px;min-height: 400px; margin: 0 auto;"></div>
    </div>
    <br /><br />
    <%= render 'graph_condition' %>

  <% end %>

  <% if params[:graph_view] == "2" %>
    <p></p>
    <div id="main_container">
      <div id="container" style="min-width:900px;min-height: 400px; margin: 0 auto;float:left;border:4px grey solid;"></div>
    </div>
    <div id="bar_container" style="display: none;">
      <div id="bar_container_graph" style="min-width: 900px;min-height: 400px; margin: 0 auto;float:left;border:4px grey solid;"></div>
    </div>
    <div id="pie_container" style="display: none;">
      <% if @pie_sum_totals.to_i > 0 %>
        <div id="pie_container_graph" style="min-width: 900px;min-height: 400px; margin: 0 auto;float:left;border:4px grey solid;"></div>
      <% else %>
        <div id="pie_container_graph" style="min-width: 900px; height: 400px; margin: 0 auto">No Records Found</div>
      <% end %>
    </div>
  <% end %>

<% else %>
  <div id="container" style="min-width: 400px; height: 400px; margin: 0 auto">No Records Found</div>
<% end %>
<%= hidden_field_tag "graph_view", params[:graph_view] %>


